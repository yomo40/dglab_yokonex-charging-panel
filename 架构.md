┌─────────────────────────────────────────────────────────────────┐
│                        用户关系模型                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   场景1: 远程控制                                                │
│   ┌──────┐                      ┌──────┐                        │
│   │用户1 │ ──── 控制指令 ────→ │用户2 │                         │
│   │(手机)│                      │(PC+设备)│                      │
│   └──────┘                      └──────┘                        │
│                                                                 │
│   场景2: 游戏对战惩罚                                            │
│   ┌──────┐         房间         ┌──────┐                        │
│   │用户3 │ ←───── 对战 ──────→ │用户4 │                         │
│   │(PC+设备)│                   │(PC+设备)│                      │
│   └──────┘                      └──────┘                        │
│       ↓ 游戏失败                    ↓ 游戏失败                   │
│   接受电击惩罚                  接受电击惩罚                      │
│                                                                 │
│   场景3: 多人房间                                                │
│   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐                        │
│   │用户A │  │用户B │  │用户C │  │用户D │                         │
│   └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘                        │
│      └─────────┴─────────┴─────────┘                            │
│                    房间                                          │
│         (互相可见状态，可互相控制)                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘



┌─────────────────────────────────────────────────────────────────┐
│                    GameAdapterPanel                             │
│                  (单一应用，多端适配)                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    UI 层                                 │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐            │    │
│  │  │ Avalonia  │  │   MAUI    │  │  Web(预留) │            │    │
│  │  │  (Win/Mac │  │ (Android  │  │           │            │    │
│  │  │   /Linux) │  │   /iOS)   │  │           │            │    │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘            │    │
│  └────────┼──────────────┼──────────────┼──────────────────┘    │
│           └──────────────┼──────────────┘                       │
│                          ↓                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  Core 核心层                             │    │
│  │                                                          │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │    │
│  │  │ 设备模块    │  │  OCR模块    │  │ 游戏适配模块 │      │    │
│  │  │ ├─郊狼     │  │ ├─内置引擎  │  │ ├─插件系统   │      │    │
│  │  │ ├─役次元   │  │ ├─自定义模型│  │ ├─规则引擎   │      │    │
│  │  │ └─扩展接口 │  │ └─血条/数字 │  │ └─脚本执行   │      │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │    │
│  │                                                          │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │    │
│  │  │ 网络模块    │  │ 数据模块    │  │ 事件模块    │      │    │
│  │  │ ├─P2P直连  │  │ ├─SQLite   │  │ ├─本地事件  │      │    │
│  │  │ ├─房间系统 │  │ ├─配置管理 │  │ ├─远程事件  │      │    │
│  │  │ └─云端中转 │  │ └─日志系统 │  │ └─事件同步  │      │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                       房间系统                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  创建房间:                                                       │
│  ┌──────┐                                                       │
│  │用户A │ ──创建房间──→ 生成房间码: ABC123                       │
│  └──────┘              (可选: 设置密码/人数限制/权限)            │
│                                                                 │
│  加入房间:                                                       │
│  ┌──────┐                                                       │
│  │用户B │ ──输入房间码──→ 加入房间 ABC123                        │
│  └──────┘                                                       │
│                                                                 │
│  房间内通信:                                                     │
│  ┌────────────────────────────────────────────────────────┐     │
│  │                     房间 ABC123                         │     │
│  │  ┌──────┐  ┌──────┐  ┌──────┐                          │     │
│  │  │用户A │  │用户B │  │用户C │                           │     │
│  │  │PC+郊狼│  │PC+役次元│  │手机(无设备)│                   │     │
│  │  └──┬───┘  └──┬───┘  └──┬───┘                          │     │
│  │     │         │         │                              │     │
│  │     ↓ 广播状态/接收指令  ↓                              │     │
│  │  ┌─────────────────────────────────────────────────┐   │     │
│  │  │              房间状态同步                        │   │     │
│  │  │  - 用户列表 (谁在线/谁有设备)                    │   │     │
│  │  │  - 设备状态 (连接/强度/模式)                     │   │     │
│  │  │  - 游戏状态 (血量/护甲/死亡)                     │   │     │
│  │  │  - 控制权限 (谁可以控制谁)                       │   │     │
│  │  └─────────────────────────────────────────────────┘   │     │
│  └────────────────────────────────────────────────────────┘     │
│                                                                 │
│  连接方式:   需要内置支持模式1                                                    │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │  模式1: P2P    │  │ 模式2: 中转    │  │ 模式3: 混合    │    │
│  │  房主开端口    │  │  云服务器中转  │  │  优先P2P      │    │
│  │  直接连接      │  │  无需开端口    │  │  失败则中转    │    │
│  │  延迟最低      │  │  穿透NAT       │  │  最佳体验      │    │
│  └────────────────┘  └────────────────┘  └────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                       权限系统                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户角色 (非固定，可切换):                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │   控制者     │  │   被控者     │  │   观察者     │            │
│  │  可发送指令  │  │  接收指令    │  │  只能观看    │            │
│  │  可观看状态  │  │  可拒绝控制  │  │  不能操作    │            │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
│                                                                 │
│  权限授予:                                                       │
│  ┌──────┐                      ┌──────┐                         │
│  │用户A │ ──请求控制权限────→ │用户B │                          │
│  └──────┘                      └──┬───┘                         │
│                                   ↓                             │
│                            [同意] / [拒绝]                       │
│                                   ↓                             │
│                         授权成功 / 授权失败                      │
│                                                                 │
│  对战模式:                                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    游戏对战房间                          │    │
│  │                                                          │    │
│  │  规则: 游戏中死亡 → 触发对方设备电击                      │    │
│  │                                                          │    │
│  │  ┌──────┐                          ┌──────┐              │    │
│  │  │用户A │  ←──── 互相绑定 ────→   │用户B │              │    │
│  │  │ 血量 │                          │ 血量 │              │    │
│  │  └──┬───┘                          └──┬───┘              │    │
│  │     │                                  │                 │    │
│  │     ↓ 死亡事件                         ↓ 死亡事件        │    │
│  │  触发用户B设备                     触发用户A设备          │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
